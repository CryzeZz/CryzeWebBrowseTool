!function(d){var u;function s(e,t,o){for(var n=o||{},r=(n.sheetname=n.sheetname||"sheet1",n.filename=n.filename||"导出表",n.showHidden=!!n.showHidden,[]),a=0,s=(e="function"==typeof n.filter?d.grep(e,function(e){return n.filter.call(window,e)}):e).length;a<s;a++)r.push(function(e,t,o,n){for(var r={},a=0;a<t.length;a++)for(var s=t[a],i=0;i<s.length;i++){var d,f,l=s[i];l.hidden&&!n||!l.field||(d=l.title||l.field,"function"==typeof l.formatter?(f=u(l.formatter(e[l.field]||"",e,o)||""),r[d]=f):r[d]=e[l.field]||"")}return r}(e[a],t,a,n.showHidden));var o=XLSX.utils.book_new(),i=XLSX.utils.json_to_sheet(r);XLSX.utils.book_append_sheet(o,i,n.sheetname),XLSX.writeFile(o,n.filename+".xlsx")}d&&d.fn&&d.fn.datagrid&&(d.fn.datagrid.methods.exportXLSX=function(e,a){return e.each(function(){var e,t,o,n=d.data(this,"datagrid"),r=n.options;(a=a||{}).allPage?(e=r.url,t=r.queryParams,t=d.extend({},t),"function"==typeof r.onBeforeLoad&&r.onBeforeLoad.call(this,t),o={page:1,rows:3e4},r.remoteSort&&r.sortName&&(o.sort=r.sortName,o.order=r.sortOrder),e&&""!=e?d.post(e,d.extend({},t,o),"","json").done(function(e){console.log(e),"object"==typeof e.rows?s(e.rows,r.columns,a):e.IsSuccess?s(jQuery.parseJSON(e.Msg).rows,r.columns,a):alert(e.Msg||"错误")}):s(n.data&&(("scrollview"==r.view.type?n.data.firstRows:n.data.rows)||n.data)||[],r.columns,a)):s(d(this).datagrid("getRows"),r.columns,a)})},u=function(e){return e.replace(/(<[^>]+>)|(&nbsp;)/gi,"")})}(jQuery);